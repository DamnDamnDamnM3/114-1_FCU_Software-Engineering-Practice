# 資料庫設定說明

本文件說明如何設定資料庫連線與啟用預設使用者功能。

## 目錄
1. [設定環境變數](#設定環境變數)
2. [測試資料庫連線](#測試資料庫連線)
3. [初始化資料庫](#初始化資料庫)
4. [啟用預設使用者功能](#啟用預設使用者功能)

## 設定環境變數

1. 在 `ENV` 目錄下建立 `.env` 檔案（如果尚未建立）

2. 設定資料庫連線參數：

```env
# 資料庫連線設定
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=你的密碼
DB_NAME=app_db

# 應用程式設定
SECRET_KEY=dev-secret-key-change-in-production

# 預設使用者設定
CREATE_DEFAULT_USER=1
DEFAULT_USERNAME=admin
DEFAULT_PASSWORD=admin123
DEFAULT_EMAIL=admin@example.com
```

**重要說明：**
- `DB_PASSWORD`: 請填入您的 MariaDB/MySQL root 密碼
- `DB_NAME`: 資料庫名稱（預設為 `app_db`）
- `CREATE_DEFAULT_USER`: 設定為 `1` 以啟用預設使用者功能

## 測試資料庫連線

使用提供的測試腳本來確認資料庫連線是否正常：

```bash
python3 src/scripts/test_db_connection.py
```

**測試腳本會檢查：**
1. MariaDB 驅動是否已安裝
2. 能否連線到 MariaDB 伺服器
3. 指定的資料庫是否存在
4. 資料庫中的資料表

**成功輸出範例：**
```
[INFO] 開始測試資料庫連線...
[INFO] 連線設定:
  - Host: 127.0.0.1
  - Port: 3306
  - User: root
  - Database: app_db

[測試 1] 連線到 MariaDB 伺服器...
[OK] 成功連線到 MariaDB 伺服器
[INFO] MariaDB 版本: 10.11.5-MariaDB

[測試 2] 連線到資料庫 'app_db'...
[OK] 成功連線到資料庫: app_db
[OK] 資料庫中有 1 個資料表:
  - users

[OK] 資料庫連線測試完成！
```

**如果連線失敗，請檢查：**
- MariaDB/MySQL 服務是否正在運行
- 連線設定（host, port, user, password）是否正確
- 防火牆設定是否允許連線
- 資料庫是否已建立（如果不存在，請先執行初始化腳本）

## 初始化資料庫

如果資料庫尚未初始化，請執行：

```bash
python3 src/scripts/init_db.py
```

此腳本會：
1. 建立資料庫（如果不存在）
2. 建立 `users` 資料表
3. 根據環境變數決定是否建立預設使用者

## 啟用預設使用者功能

### 方法一：透過環境變數（推薦）

在 `ENV/.env` 檔案中設定：

```env
CREATE_DEFAULT_USER=1
DEFAULT_USERNAME=admin
DEFAULT_PASSWORD=admin123
DEFAULT_EMAIL=admin@example.com
```

然後執行初始化腳本：

```bash
python3 src/scripts/init_db.py
```

### 方法二：透過命令列環境變數

```bash
CREATE_DEFAULT_USER=1 python3 src/scripts/init_db.py
```

### 預設使用者資訊

- **使用者名稱**: `admin`（可透過 `DEFAULT_USERNAME` 修改）
- **密碼**: `admin123`（可透過 `DEFAULT_PASSWORD` 修改）
- **電子郵件**: `admin@example.com`（可透過 `DEFAULT_EMAIL` 修改）

**安全提醒：**
- 預設密碼為 `admin123`，請在正式環境中更改
- 如果資料表中已有使用者，腳本會跳過建立預設使用者

### 驗證預設使用者是否建立成功

執行初始化腳本後，如果成功建立預設使用者，會看到：

```
[OK] 已建立預設使用者: admin
[WARN] 請在正式環境中更改預設使用者密碼！
```

如果資料表中已有使用者，會看到：

```
[INFO] 資料表中已有使用者，跳過建立預設使用者
```

## 完整設定流程

1. **建立環境變數檔案**
   ```bash
   # 如果 ENV/.env 不存在，請建立它
   mkdir -p ENV
   # 編輯 ENV/.env 並填入資料庫連線資訊
   ```

2. **測試資料庫連線**
   ```bash
   python3 src/scripts/test_db_connection.py
   ```

3. **初始化資料庫並建立預設使用者**
   ```bash
   # 確保 ENV/.env 中設定 CREATE_DEFAULT_USER=1
   python3 src/scripts/init_db.py
   ```

4. **再次測試連線確認**
   ```bash
   python3 src/scripts/test_db_connection.py
   ```

## 疑難排解

### 問題：無法連線到資料庫

**可能原因：**
- MariaDB/MySQL 服務未啟動
- 連線設定錯誤（host, port, user, password）
- 防火牆阻擋連線

**解決方法：**
1. 檢查服務狀態：`sudo systemctl status mariadb` 或 `sudo systemctl status mysql`
2. 確認連線設定是否正確
3. 檢查防火牆設定

### 問題：資料庫不存在

**解決方法：**
執行初始化腳本會自動建立資料庫：
```bash
python3 src/scripts/init_db.py
```

### 問題：預設使用者未建立

**可能原因：**
- `CREATE_DEFAULT_USER` 未設定為 `1`
- 資料表中已有使用者

**解決方法：**
1. 確認 `ENV/.env` 中 `CREATE_DEFAULT_USER=1`
2. 如果資料表中已有使用者，需要先清空或手動建立

### 問題：MariaDB 驅動未安裝

**解決方法：**
```bash
pip install mariadb
```

## 相關檔案

- `src/scripts/init_db.py` - 資料庫初始化腳本
- `src/scripts/test_db_connection.py` - 資料庫連線測試腳本
- `src/services/db.py` - 資料庫連線服務
- `ENV/.env` - 環境變數設定檔（需自行建立）

